<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美团星级评价识别与评分计算工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        meituan: '#00C1D4',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .status-transition {
                transition: all 0.5s ease-in-out;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 页面标题 -->
        <header class="text-center mb-10">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-gray-800 mb-2">美团星级评价识别与评分计算工具</h1>
            <p class="text-gray-600 text-lg">自动计算美团评分及期望评分所需好评量(王立猛监制)</p>
        </header>

        <!-- 主要内容区 -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 左侧：上传区域 -->
            <div class="bg-white rounded-xl shadow-soft p-6 flex flex-col">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fa fa-upload text-primary mr-2"></i>上传图片
                </h2>
                
                <!-- 拖放区域 -->
                <div id="dropArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6 cursor-pointer transition-all duration-300 hover:border-primary hover:bg-blue-50">
                    <i class="fa fa-image text-5xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600 mb-2">拖放图片到这里，或点击选择图片</p>
                    <p class="text-sm text-gray-500">支持 JPG, PNG, GIF 格式（含美团星级评价的图片）</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>
                
                <!-- 预览图片 -->
                <div id="previewContainer" class="hidden mb-6">
                    <h3 class="text-gray-700 font-medium mb-2">预览图片：</h3>
                    <div class="border rounded-lg overflow-hidden">
                        <img id="previewImage" src="" alt="预览图片" class="w-full h-auto max-h-64 object-contain">
                    </div>
                </div>
                
                <!-- 识别按钮 -->
                <button id="recognizeBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed mt-auto flex items-center justify-center">
                    <i class="fa fa-magic mr-2"></i>识别星级评价
                </button>
            </div>
            
            <!-- 右侧：结果区域 -->
            <div class="flex flex-col gap-6">
                <!-- 星级统计结果 -->
                <div class="bg-white rounded-xl shadow-soft p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-bar-chart text-accent mr-2"></i>星级统计结果
                    </h2>
                    
                    <!-- 加载状态 -->
                    <div id="loadingIndicator" class="hidden flex items-center justify-center py-10 status-transition">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent" id="loadingSpinner"></div>
                        <div id="loadingTextContainer">
                            <p class="ml-3 text-gray-600">正在分析图片中的星级评价...</p>
                        </div>
                        <div id="successIndicator" class="hidden items-center">
                            <i class="fa fa-check-circle text-secondary text-3xl"></i>
                            <p class="ml-3 text-gray-600">星级评价分析完成</p>
                        </div>
                    </div>
                    
                    <!-- 初始提示 -->
                    <div id="initialMessage" class="text-center py-10 text-gray-500">
                        <i class="fa fa-info-circle text-3xl mb-3"></i>
                        <p>上传包含星级评价的图片并点击"识别星级评价"按钮</p>
                    </div>
                    
                    <!-- 错误信息 -->
                    <div id="errorMessage" class="hidden text-center py-10 text-red-500">
                        <i class="fa fa-exclamation-circle text-3xl mb-3"></i>
                        <p id="errorText">识别失败，请重试</p>
                    </div>
                    
                    <!-- 结果区域 -->
                    <div id="starResultContainer" class="hidden">
                        <div class="bg-gray-50 rounded-lg p-4 min-h-[150px] max-h-[300px] overflow-y-auto mb-4">
                            <pre id="starResultText" class="text-gray-800 whitespace-pre-wrap"></pre>
                        </div>
                        <div class="flex justify-end">
                            <button id="starCopyBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-all duration-300 flex items-center">
                                <i class="fa fa-copy mr-2"></i>复制JSON结果
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 评分计算结果 -->
                <div class="bg-white rounded-xl shadow-soft p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-calculator text-secondary mr-2"></i>美团评分计算结果
                    </h2>
                    
                    <!-- 初始提示 -->
                    <div id="scoreInitialMessage" class="text-center py-10 text-gray-500">
                        <i class="fa fa-line-chart text-3xl mb-3"></i>
                        <p>星级识别完成后将自动计算评分结果</p>
                    </div>
                    
                    <!-- 计算结果区域 -->
                    <div id="scoreResultContainer" class="hidden">
                        <!-- 当前评分 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">当前美团评分：</h3>
                            <div class="bg-meituan/10 border border-meituan/20 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fa fa-star text-meituan mr-2"></i>
                                    <span class="font-medium">评分详情</span>
                                </div>
                                <p id="meituanScore" class="text-3xl font-bold text-meituan">0.0</p>
                                <p class="text-sm text-gray-600 mt-1">计算公式：(1×1星 + 2×2星 + 3×3星 + 4×4星 + 5×5星) / 评价总数</p>
                                <p class="text-sm text-gray-600 mt-1" id="totalReviews">总评价数：0 条</p>
                            </div>
                        </div>
                        
                        <!-- 期望评分计算 -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-3">达到目标评分所需5星评价量：</h3>
                            <div class="space-y-3">
                                <div class="bg-gray-50 rounded-lg p-3 flex justify-between items-center">
                                    <div>
                                        <span>达到4.7分需要补充：</span>
                                        <!-- <p class="text-xs text-gray-500 mt-1">注：评分≥4.65时显示为4.7</p> -->
                                    </div>
                                    <span id="needFor47" class="font-bold text-primary">0 条5星评价</span>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 flex justify-between items-center">
                                    <div>
                                        <span>达到4.8分需要补充：</span>
                                        <!-- <p class="text-xs text-gray-500 mt-1">注：评分≥4.75时显示为4.8</p> -->
                                    </div>
                                    <span id="needFor48" class="font-bold text-primary">0 条5星评价</span>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 flex justify-between items-center">
                                    <div>
                                        <span>达到4.9分需要补充：</span>
                                        <!-- <p class="text-xs text-gray-500 mt-1">注：评分≥4.85时显示为4.9</p> -->
                                    </div>
                                    <span id="needFor49" class="font-bold text-primary">0 条5星评价</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>由茶百道陶溪川技术部提供技术支持</p>
        </footer>
    </div>

    <script>
        // DOM 元素
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const recognizeBtn = document.getElementById('recognizeBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingTextContainer = document.getElementById('loadingTextContainer');
        const successIndicator = document.getElementById('successIndicator');
        const initialMessage = document.getElementById('initialMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const starResultContainer = document.getElementById('starResultContainer');
        const starResultText = document.getElementById('starResultText');
        const starCopyBtn = document.getElementById('starCopyBtn');
        const scoreInitialMessage = document.getElementById('scoreInitialMessage');
        const scoreResultContainer = document.getElementById('scoreResultContainer');
        const meituanScore = document.getElementById('meituanScore');
        const totalReviews = document.getElementById('totalReviews');
        const needFor47 = document.getElementById('needFor47');
        const needFor48 = document.getElementById('needFor48');
        const needFor49 = document.getElementById('needFor49');
        
        // 评分阈值配置
        const SCORE_THRESHOLDS = {
            '4.7': 4.65,
            '4.8': 4.75,
            '4.9': 4.85
        };
        
        // 选中的文件
        let selectedFile = null;
        let imageDataUrl = null;
        
        // 初始化按钮状态
        recognizeBtn.disabled = true;

        // 拖放事件
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('border-primary');
            dropArea.classList.add('bg-blue-50');
        }

        function unhighlight() {
            dropArea.classList.remove('border-primary');
            dropArea.classList.remove('bg-blue-50');
        }

        // 处理文件拖放
        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            if (file) {
                handleFiles(file);
            }
        }

        // 点击上传区域触发文件选择
        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        // 文件选择变化
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFiles(file);
            }
        });

        // 处理选择的文件
        function handleFiles(file) {
            if (!file.type.match('image.*')) {
                showError('请选择图片文件');
                return;
            }

            selectedFile = file;
            recognizeBtn.disabled = false;

            const reader = new FileReader();
            reader.onload = (e) => {
                imageDataUrl = e.target.result;
                previewImage.src = imageDataUrl;
                previewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);

            resetResultAreas();
        }

        // 显示分析完成状态
        function showAnalysisComplete() {
            // 隐藏加载动画，显示成功标识
            loadingSpinner.classList.add('hidden');
            loadingTextContainer.classList.add('hidden');
            successIndicator.classList.remove('hidden');
            successIndicator.style.display = 'flex';

            // 2秒后自动切换到结果显示
            setTimeout(() => {
                starResultContainer.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            }, 2000);
        }

        // 计算评分和所需5星评价量
        function calculateScores(starData) {
            const star1 = starData['1星'] || 0;
            const star2 = starData['2星'] || 0;
            const star3 = starData['3星'] || 0;
            const star4 = starData['4星'] || 0;
            const star5 = starData['5星'] || 0;
            const total = star1 + star2 + star3 + star4 + star5;

            totalReviews.textContent = `总评价数：${total} 条`;

            if (total > 0) {
                const meituanTotal = 1*star1 + 2*star2 + 3*star3 + 4*star4 + 5*star5;
                const meituanScoreVal = (meituanTotal / total).toFixed(1);
                meituanScore.textContent = meituanScoreVal;
            } else {
                meituanScore.textContent = '0.0（无评价）';
            }

            if (total > 0 && meituanScore.textContent !== '0.0（无评价）') {
                const currentScore = parseFloat(meituanScore.textContent);
                const currentTotal = total;

                const x47 = calculateNeededStars(currentScore, currentTotal, SCORE_THRESHOLDS['4.7']);
                needFor47.textContent = `${x47} 条5星评价`;

                const x48 = calculateNeededStars(currentScore, currentTotal, SCORE_THRESHOLDS['4.8']);
                needFor48.textContent = `${x48} 条5星评价`;

                const x49 = calculateNeededStars(currentScore, currentTotal, SCORE_THRESHOLDS['4.9']);
                needFor49.textContent = `${x49} 条5星评价`;
            } else {
                needFor47.textContent = '无法计算（无评价）';
                needFor48.textContent = '无法计算（无评价）';
                needFor49.textContent = '无法计算（无评价）';
            }

            scoreInitialMessage.classList.add('hidden');
            scoreResultContainer.classList.remove('hidden');
        }

        // 计算达到期望评分阈值所需的5星评价数
        function calculateNeededStars(currentScore, currentTotal, targetThreshold) {
            const numerator = currentScore * currentTotal - targetThreshold * currentTotal;
            const denominator = targetThreshold - 5;

            if (denominator === 0) return 0;

            let x = numerator / denominator;
            x = Math.ceil(x);
            return x < 0 ? 0 : x;
        }

        // 开始识别 - 修改为调用本地API
        recognizeBtn.addEventListener('click', async () => {
            if (!selectedFile || !imageDataUrl) return;

            showLoading();

            try {
                const response = await fetch('/api/recognize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageData: imageDataUrl
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || `API请求失败 (状态码: ${response.status})`);
                }

                const starResult = result.data;
                starResultText.textContent = JSON.stringify(starResult, null, 2);

                // 显示分析完成状态
                showAnalysisComplete();

                // 计算评分
                calculateScores(starResult);

            } catch (error) {
                console.error('识别错误:', error);
                showError(error.message || '识别过程中发生错误，请重试');
            }
        });

        // 复制星级结果
        starCopyBtn.addEventListener('click', () => {
            const text = starResultText.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = starCopyBtn.innerHTML;
                starCopyBtn.innerHTML = '<i class="fa fa-check mr-2"></i>已复制';
                starCopyBtn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                starCopyBtn.classList.add('bg-green-200', 'hover:bg-green-300');

                setTimeout(() => {
                    starCopyBtn.innerHTML = originalText;
                    starCopyBtn.classList.remove('bg-green-200', 'hover:bg-green-300');
                    starCopyBtn.classList.add('bg-gray-200', 'hover:bg-gray-300');
                }, 2000);
            });
        });

        // 状态控制函数
        function showLoading() {
            initialMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            starResultContainer.classList.add('hidden');
            scoreInitialMessage.classList.remove('hidden');
            scoreResultContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            // 重置加载状态元素
            loadingSpinner.classList.remove('hidden');
            loadingTextContainer.classList.remove('hidden');
            successIndicator.classList.add('hidden');
            successIndicator.style.display = 'none';
        }

        function showError(message) {
            loadingIndicator.classList.add('hidden');
            starResultContainer.classList.add('hidden');
            scoreResultContainer.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            errorText.textContent = message;
        }

        function resetResultAreas() {
            loadingIndicator.classList.add('hidden');
            errorMessage.classList.add('hidden');
            starResultContainer.classList.add('hidden');
            scoreResultContainer.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            scoreInitialMessage.classList.remove('hidden');
        }
    </script>
</body>
</html>
